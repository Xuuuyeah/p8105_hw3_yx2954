---
title: "p8105_hw3_yx2954"
author: "Yiran Xu"
date: "2024-10-10"
output: github_document
---

```{r}
library(p8105.datasets)
library(dplyr)
library(lubridate)
library(ggplot2)
library(ggridges)
```


# Problem 1

## First, let’s take a few minutes to understand the dataset and the variables it contains.

```{r}
str(ny_noaa)
nrow(ny_noaa)
ncol(ny_noaa)

n_station = 
  ny_noaa |>
  pull(id) |>
  n_distinct()

date_range = ny_noaa |>
  pull(date) |>
  range(na.rm = TRUE)
```

## Next, check the range of key variables

### prcp

```{r}
max_prcp_info = ny_noaa |>
  filter(prcp == max(prcp, na.rm = TRUE)) |>
  select(id, date, prcp)

min_prcp_info = ny_noaa |>
  filter(prcp == min(prcp, na.rm = TRUE)) |>
  select(id, date, prcp)
```

### snow & snwd

```{r}
max_snow_info = ny_noaa |>
  filter(snow == max(snow, na.rm = TRUE)) |>
  select(id, date, snow)

min_snow_info = ny_noaa |>
  filter(snow == min(snow, na.rm = TRUE)) |>
  select(id, date, snow)

max_snwd_info = ny_noaa |>
  filter(snwd == max(snwd, na.rm = TRUE)) |>
  select(id, date, snwd)

min_snwd_info = ny_noaa |>
  filter(snwd == min(snwd, na.rm = TRUE)) |>
  select(id, date, snwd)
```

### tmax & tmin

```{r}
max_tmax_info = ny_noaa |>
  mutate(tmax = as.numeric(tmax)) |>
  filter(tmax == max(tmax, na.rm = TRUE)) |>
  select(id, date, tmax, tmin)

min_tmax_info = ny_noaa |>
  mutate(tmax = as.numeric(tmax)) |>
  filter(tmax == min(tmax, na.rm = TRUE)) |>
  select(id, date, tmax, tmin)

max_tmin_info = ny_noaa |>
  mutate(tmin = as.numeric(tmin)) |>
  filter(tmin == max(tmin, na.rm = TRUE)) |>
  select(id, date, tmin)

min_tmin_info = ny_noaa |>
  mutate(tmin = as.numeric(tmin)) |>
  filter(tmin == min(tmin, na.rm = TRUE)) |>
  select(id, date, tmin)
```

## Then, count missing info

```{r}
na_snow = ny_noaa |>
  filter(is.na(snow)) |>
  count() 

na_snwd = ny_noaa |>
  filter(is.na(snwd)) |>
  count()

na_tmax = ny_noaa |>
  filter(is.na(tmax)) |>
  count()

na_tmin = ny_noaa |>
  filter(is.na(tmin)) |>
  count()
```

## Description

*   The table size is **`r nrow(ny_noaa)`** by **`r ncol(ny_noaa)`**. Variables includes **id** (the identifier for specific weather station), **date**, **prcp(precipitation)**, **snow(snowfall)**, **snwd(snow depth in millimeters)**, **maximum and minimun temperature**. 
*   This table contains data from **`r n_station`** distinct stations in total from **`r date_range[1]`** to **`r date_range[2]`**.
*   The maximum precipitation was **`r max_prcp_info[3]`** observed on **`r max_prcp_info[2]`** at **`r max_prcp_info[1]`**. The minimum is **0**, as expected. There were **`r nrow(min_prcp_info)`** days without raning.
*   The maximum snowfall was **`r max_snow_info[3]`** on **`r max_snow_info[2]`** at **`r max_snow_info[1]`**, while the minimum was **`r min_snow_info[3]`** on **`r min_snow_info[2]`** at **`r min_snow_info[1]`**. An recording error may occur on that day as the snowfall cannot be negative.
*   The maximum snow depth was **`r max_snwd_info[3]`** observed on **`r max_snwd_info[2]`** at **`r max_snwd_info[1]`**. The minimum is **0** as expected. There were **`r nrow(min_snwd_info)`** days without snow accumulation.
*   The maximum tmax was **`r max_tmax_info[1,3]`** observed on **`r nrow(max_tmax_info)`** different days. The minimum was **`r min_tmax_info[3]`** observed on **`r min_tmax_info[2]`** at **`r min_tmax_info[1]`**.
*   The maximum tmin was **`r max_tmin_info[1,3]`** on **`r nrow(max_tmin_info)`** different days. The minimum was **`r min_tmin_info[3]`** on **`r min_tmin_info[2]`** at **`r min_tmin_info[1]`**
*   There is a high degree of missing information in the table. For snow and snwd, about **`r round(na_snow/nrow(ny_noaa)*100, 2)`%** and **`r round(na_snwd/nrow(ny_noaa)*100, 2)`%** are missing information, respectively. **`r round(na_tmax/nrow(ny_noaa)*100, 2)`%** and **`r round(na_tmin/nrow(ny_noaa)*100, 2)`%** of max and min temperature are missing.

## data cleaning
*   Clean name;
*   Convert tmax and tmin to numeric data;
*   Keep temperature, precipitation, snowfall in reasonable units 
*   Create seperate columns for year, month and day
*   Remove error, i.e. tmax <= tmin; snow < 0;
*   Remove empty row

```{r}
ny_noaa_clean = ny_noaa |>
  janitor::clean_names() |>
  mutate(tmax = as.numeric(tmax) / 10, 
         tmin = as.numeric(tmin) / 10,
         prcp = prcp / 10,
         year = year(date),
         month = month(date),
         day = day(date)) |> 
  select(year, month, day, everything(), -date) |>
  filter(tmax > tmin | is.na(tmax) | is.na(tmin)) |>
  filter(snow >= 0 | is.na(snow)) |>
  filter(!(is.na(snow) & is.na(snwd) & is.na(tmax) & is.na(tmin) & is.na(prcp))) |>
  rename(
    tmax_c = tmax,     
    tmin_c = tmin,     
    prcp_mm = prcp,   
    snow_mm = snow,    
    snwd_mm = snwd     
  )
```

## Count most common snowfall

```{r}
ny_noaa_clean |> 
  count(snow_mm) |>
  arrange(desc(n)) 
```

For snowfall, the most commonly observed values is 0mm among with 2007240	observations, as there is no snow in most of the days.

## make two-panel plot

### filter and group data

```{r}
avg_tmax_df = 
  ny_noaa_clean |>
  filter(month %in% c(1, 7) & !is.na(tmax_c)) |>
  group_by(id, month) |>
  summarise(avg_tmax = mean(tmax_c))
```

### make plot

```{r}
avg_tmax_p = ggplot(avg_tmax_df, aes(y = avg_tmax, fill = factor(month, labels = c("January", "July")))) +
  geom_boxplot() +  
  facet_grid(.~ month, labeller = labeller(month = c(`1` = "January", `7` = "July"))) +
  labs(title = "Average Max Temperature in January and July by Station",
       x = "Station",
       y = "Average Max Temperature (°C)",
       fill = "Month") +
  theme(axis.text.x = element_blank()) 

ggsave(filename = "data/plots/avg_tmax.png", avg_tmax_p)
```

It can be noticed that the average max temperature in January is greatly lower than that in July. Outliers in both panel can be detected. The average temperature in some station significantly higher or lower than the mean.

## make other plots

### geom_hex
```{r}
hex_p = ggplot(ny_noaa_clean, aes(x = tmin_c, y = tmax_c)) + 
  geom_hex() + 
  labs(x = "t_min (°C)",
       y = "t_max (°C)")
ggsave(filename = "data/plots/tmax_tmin.png", hex_p)
```

### Ridge plot
```{r}
ridge_p = ny_noaa_clean |>
  filter(snow_mm > 0 & snow_mm< 100) |>
  ggplot(aes(x = snow_mm, y = as.factor(year))) + 
  geom_density_ridges() +
  labs(
    x = "Snowfall (mm)",
    y = "Frequency",
    title = "Distribution of Snowfall Values Greater Than 0 and Less Than 100 by Year"
  ) +
  scale_y_discrete(expand = expansion(add = c(1, 2)))
ggsave(filename = "data/plots/snow_dist.png", ridge_p)
```

# Problem 2

```{r}

```


